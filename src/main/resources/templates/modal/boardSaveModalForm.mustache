<div class="modal fade" id="boardSaveModal" tabindex="-1" aria-labelledby="boardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="boardModalLabel">글쓰기</h5>
                <button id="closeModalBtn" type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="boardForm" action="/board/1" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <!-- 텍스트 에디터와 이미지 미리보기 컨테이너 -->
                        <div style="position: relative; height: 400px; border: 1px solid #D6D6D6; border-radius: 4px;">
                            <div id="imagePreview"
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100px; overflow-y: auto; display: flex; flex-wrap: wrap; overflow-x: auto;"></div>
                            <textarea name="content" id="content"
                                      style="padding: 5px 15px; border: none; border-top: 1px solid #D6D6D6; border-radius: 4px; height: 280px; width: 100%; resize: none; box-sizing: border-box; position: absolute; top: 100px;"></textarea>
                        </div>
                        <!-- 이미지 및 비디오 파일 선택 -->
                        <input name="imgFiles" id="imgFiles" type="file" style="border-radius: 4px; margin-top: 8px"
                               accept="image/*" multiple>
                        <input name="videoFiles" id="videoFiles" type="file" style="border-radius: 4px; margin-top: 8px"
                               accept="video/*" multiple>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">게시</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        var selectedImgFiles = []; // 선택된 이미지 파일들을 저장할 배열
        var selectedVideoFiles = []; // 선택된 비디오 파일들을 저장할 배열

        // 모달 내부 클릭 시 닫히지 않도록 설정
        $('#boardSaveModal .modal-content').on('click', function (event) {
            event.stopPropagation();
        });

        // 모달이 열릴 때 socialId 값을 가져와서 폼의 action 속성에 추가
        $('#boardSaveModal').on('show.bs.modal', function (event) {
            var socialId = getSocialIdFromUrl();
            var modal = $(this);
            var form = modal.find('form');
            form.attr('action', '/board/' + socialId);
        });

        // URL에서 socialId를 추출하는 함수
        function getSocialIdFromUrl() {
            var url = window.location.href; // 현재 페이지 URL 가져오기
            var matches = url.match(/\/social\/detail\/(\d+)/); // 정규 표현식으로 socialId 추출
            if (matches && matches.length > 1) {
                return matches[1]; // socialId 반환
            } else {
                return 1; // 기본값 설정 (추출 실패 시)
            }
        }

        // 이미지 및 동영상 미리보기 기능
        $('#imgFiles, #videoFiles').change(function (event) {
            const imagePreview = $('#imagePreview');
            const files = event.target.files;

            // 각 파일 순서대로 미리보기에 추가
            $.each(files, function (index, file) {
                if (file.size > 0) { // 필터링: 파일 크기가 0보다 큰 경우에만 처리
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const mediaContainer = $('<div>').addClass('media-container').css({
                            display: 'flex',
                            justifyContent: 'flex-start',
                            alignItems: 'center',
                            width: '100px',
                            height: '100px',
                            margin: '5px 0'
                        });

                        if (file.type.startsWith('image')) {
                            // 이미지 파일 처리
                            const img = $('<img>').attr({
                                src: e.target.result,
                                alt: 'image'
                            }).css({
                                width: '100px',
                                height: '100px',
                                objectFit: 'cover',
                                marginRight: '10px'
                            });
                            mediaContainer.append(img);
                            selectedImgFiles.push(file); // 배열에 이미지 파일 추가
                            console.log(selectedImgFiles)
                        } else if (file.type.startsWith('video')) {
                            // 동영상 파일 처리
                            const video = $('<video>').attr({
                                src: e.target.result,
                                controls: true,
                                alt: 'video'
                            }).css({
                                width: '100px',
                                height: '100px',
                                objectFit: 'cover',
                                marginRight: '10px'
                            });
                            mediaContainer.append(video);
                            selectedVideoFiles.push(file); // 배열에 비디오 파일 추가
                        }

                        // 새로운 미리보기 항목을 가장 마지막에 추가
                        imagePreview.append(mediaContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // 게시 버튼 클릭 시
        $('#boardForm').submit(function (event) {
            event.preventDefault();

            var formData = new FormData(this);

            // 선택된 이미지 파일들을 FormData에 추가
            $.each(selectedImgFiles, function (index, file) {
                formData.append('imgFiles', file);
            });

            // 선택된 비디오 파일들을 FormData에 추가
            $.each(selectedVideoFiles, function (index, file) {
                formData.append('videoFiles', file);
            });

            // Ajax를 통해 서버로 데이터 전송
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    // 성공 시 처리
                    location.reload();

                    $('#boardSaveModal').modal('hide');
                },
                error: function (error) {
                    // 오류 시 처리
                    console.error('전송 오류:', error);
                }
            });
        });

    });
</script>
