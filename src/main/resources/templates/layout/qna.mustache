{{> layout/header}}
<div class="qna-wrapper">
    <div class="qna-container">
        <h2>1:1 문의</h2>
        <div class="qna-tab-container">
            <div class="qna-tabs">
                <div class="qna-tab active" onclick="openTab(event, 'inquiryTab')">문의하기</div>
                <div class="qna-tab" onclick="openTab(event, 'responseTab')">답변 상태</div>
            </div>
            <div id="inquiryTab" class="qna-tab-content active">
                <div class="qna-form-group">
                    <label for="inquiryTitle">문의 제목</label>
                    <input type="text" id="inquiryTitle" placeholder="문의 제목을 입력해 주세요">
                </div>
                <div class="qna-form-group">
                    <label for="inquiryContent">문의 내용</label>
                    <textarea id="inquiryContent" rows="10" placeholder="문의 내용을 입력해 주세요"></textarea>
                </div>
                <div class="qna-button-group">
                    <button class="qna-cancel">취소하기</button>
                    <button onclick="submitInquiry()">등록하기</button>
                </div>
            </div>
            <div id="responseTab" class="qna-tab-content">
                <div class="qna-info-text">
                    상담시간: 월~금 09:00 ~18:00<br>
                    (점심시간 12:00~13:00, 토/일/공휴일 휴무)<br><br>
                    답변이 완료된 상담 내용은 수정이 불가능하오니 서비스 이용에 참고 부탁드립니다.
                </div>
                <div class="qna-info-section" id="completedAnswers">
                    <h3>답변 완료 (<span id="completedCount"></span>)</h3>
                    <!-- 완료된 문의 리스트는 서버에서 받아온 데이터로 자동 생성 -->
                </div>
                <div class="qna-info-section" id="pendingAnswers">
                    <h3>답변 대기 (<span id="pendingCount"></span>)</h3>
                    <!-- 대기 중인 문의 리스트는 서버에서 받아온 데이터로 자동 생성 -->
                </div>
                <div id="detailBox" class="qna-detail-box" style="display: none;">
                    <h4 id="detailTitle"></h4>
                    <p id="detailQuestion"></p>
                    <p id="detailAnswer"></p>
                </div>
            </div>
        </div>
        <div class="qna-company-info">
            <p>Socialize<br>고객센터 1234-5678 (유료)<br>평일 09:00 ~ 18:00 (토/일/공휴일 휴무)<br><small>(break time 12:00 ~ 13:00)</small></p>
        </div>
    </div>
</div>

<script>
    function loadAnswerCounts() {
        // 답변 완료 및 대기 중인 문의 개수 로드
        $.ajax({
            url: '/qna/my/answer/list',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                const completedCount = data.count;
                $('#completedCount').text(completedCount);

                const completedAnswersSection = $('#completedAnswers');
                completedAnswersSection.empty();
                data.list.forEach(item => {
                    const div = $('<div>').text(`완료된 문의 ${item.id}`).click(function() {
                        showDetail('completed', item.id);
                    });
                    completedAnswersSection.append(div);
                });
            },
            error: function(error) {
                console.error('Error loading completed answers:', error);
            }
        });

        $.ajax({
            url: '/qna/my/waiting/list',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                const pendingCount = data.count;
                $('#pendingCount').text(pendingCount);

                const pendingAnswersSection = $('#pendingAnswers');
                pendingAnswersSection.empty();
                data.list.forEach(item => {
                    const div = $('<div>').text(`대기 중인 문의 ${item.id}`).click(function() {
                        showDetail('pending', item.id);
                    });
                    pendingAnswersSection.append(div);
                });
            },
            error: function(error) {
                console.error('Error loading pending answers:', error);
            }
        });
    }

    function showDetail(type, id) {
        const detailBox = $('#detailBox');
        const detailTitle = $('#detailTitle');
        const detailQuestion = $('#detailQuestion');
        const detailAnswer = $('#detailAnswer');

        $.ajax({
            url: type === 'completed' ? `/qna/my/answer/${id}` : `/qna/my/waiting/${id}`,
            type: 'GET',
            dataType: 'json',
            success: function(item) {
                detailTitle.text(`${type === 'completed' ? '완료된' : '대기 중인'} 문의 ${item.id}`);
                detailQuestion.text(`질문: ${item.title}`);
                if (type === 'completed') {
                    detailAnswer.css('display', 'block').text(`답변: ${item.content || '답변이 없습니다.'}`);
                } else {
                    detailAnswer.css('display', 'none');
                }
                detailBox.css('display', 'block');
            },
            error: function(error) {
                console.error('Error loading detail:', error);
            }
        });
    }

    function submitInquiry() {
        var inquiryTitle = $('#inquiryTitle').val();
        var inquiryContent = $('#inquiryContent').val();

        $.ajax({
            url: '/qna',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                inquiryTitle: inquiryTitle,
                inquiryContent: inquiryContent
            }),
            dataType: 'json',
            success: function(data) {
                alert('문의가 등록되었습니다.');
                loadAnswerCounts(); // 문의 등록 후 상태 업데이트
            },
            error: function(error) {
                console.error('Error:', error);
                alert('문의 등록 중 오류가 발생했습니다.');
            }
        });
    }

    $(document).ready(function() {
        loadAnswerCounts(); // 페이지 로드 시 답변 상태 초기화
    });
</script>
{{> layout/footer}}
